"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.watchBAPTransactions=exports.updateLastBlock=exports.processEvent=exports.processBapTransaction=exports.parseOpReturn=exports.parseBAPTransaction=exports.isBase64=exports.getLastBlockIndex=exports.addBAPErrorTransaction=exports.FIRST_BAP_BLOCK=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_jsJunglebus=require("@gorillapool/js-junglebus"),_bpu=_interopRequireDefault(require("bpu")),_config=require("./config"),_bap=require("./schemas/bap"),_errors=require("./schemas/errors"),_aip=require("./aip"),_status=require("./status"),_yargs=require("yargs");function _createForOfIteratorHelper(a,b){var c="undefined"!=typeof Symbol&&a[Symbol.iterator]||a["@@iterator"];if(!c){if(Array.isArray(a)||(c=_unsupportedIterableToArray(a))||b&&a&&"number"==typeof a.length){c&&(a=c);var d=0,e=function(){};return{s:e,n:function n(){return d>=a.length?{done:!0}:{done:!1,value:a[d++]}},e:function e(a){throw a},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var f,g=!0,h=!1;return{s:function s(){c=c.call(a)},n:function n(){var a=c.next();return g=a.done,a},e:function e(a){h=!0,f=a},f:function f(){try{g||null==c["return"]||c["return"]()}finally{if(h)throw f}}}}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var FIRST_BAP_BLOCK=59e4;exports.FIRST_BAP_BLOCK=590000;var updateLastBlock=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(a){return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.abrupt("return",(0,_status.updateStatusValue)("lastBlock",a));case 1:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}();exports.updateLastBlock=updateLastBlock;var getLastBlockIndex=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){var b;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,(0,_status.getStatusValue)("lastBlock");case 2:return b=a.sent,a.abrupt("return",b?+b:FIRST_BAP_BLOCK);case 4:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}();exports.getLastBlockIndex=getLastBlockIndex;var addBAPErrorTransaction=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(a){return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.abrupt("return",_errors.Errors.updateOne({_id:a.txId},{$set:a},{upsert:!0}));case 1:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}();exports.addBAPErrorTransaction=addBAPErrorTransaction;var isBase64=function(a){return /^(?:[A-Za-z0-9+\/]{4})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+/]{3}=)?$/gi.test(a)};exports.isBase64=isBase64;var parseOpReturn=function(a){for(var b=a.len,c=[],d=0;d<b;d++)a["s".concat(d-3)]===_config.AIP_BITCOM_ADDRESS?a["s".concat(d)]&&isBase64(a["s".concat(d)])?c.push(a["s".concat(d)]):c.push(a["b".concat(d)]):c.push(a["s".concat(d)]||a["o".concat(d)]||a["h".concat(d)]||a["b".concat(d)]);console.log({opReturn:c}),"OP_0"===c[0]&&c.shift(),c.shift();for(var e=(0,_defineProperty2["default"])({},c[0],[]),f=c[0],g=0;g<c.length;g++)"|"===c[g]?(f=c[g+1],f===_config.BAP_BITCOM_ADDRESS?("DATA"===c[g+2]&&c[g+3]===e[_config.BAP_BITCOM_ADDRESS][2]&&e[_config.BAP_BITCOM_ADDRESS].push(c[g+4]),g+=4):e[f]=[]):e[f].push(c[g]);return e};exports.parseOpReturn=parseOpReturn;var processBapTransaction=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(a){var c,d,e;return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(a){b.next=2;break}return b.abrupt("return");case 2:return c=_objectSpread({_id:a.txId},a),delete c.txId,c.processed=!1,b.next=7,_bap.BAP.findOne({_id:c._id});case 7:if(d=b.sent,!d){b.next=16;break}return e=c._id,delete c._id,d.timestamp&&delete c.timestamp,b.next=14,_bap.BAP.updateOne({_id:e},{$set:c});case 14:b.next=18;break;case 16:return b.next=18,_bap.BAP.insert(c);case 18:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}();exports.processBapTransaction=processBapTransaction;var parseBAPTransaction=function(a,b,c){if(!a||!a[0]||a[0].s!==_config.BAP_BITCOM_ADDRESS||!a[1].s||!a[2].s||!a[3].s)return!1;var d=(0,_aip.validAIPSignature)(a,b,c);if(!d)return!1;var e={type:a[1].s,hash:a[2].s,sequence:a[3].s,signatureAddress:b[2].s};return c&&c[2].s===a[2].s&&(e.data=c[3].s),e};exports.parseBAPTransaction=parseBAPTransaction;var processEvent=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function d(a,b,c){var e,f,g,h,i,j,k,l,m,n;return _regenerator["default"].wrap(function(d){for(;;)switch(d.prev=d.next){case 0:return d.next=2,_bpu["default"].parse({tx:{r:a},split:[{token:{op:106},include:"l"},{token:{op:0},include:"l"},{token:{s:"|"}}]});case 2:if(e=d.sent,f=e.tx.h,c=c||Math.round(+new Date/1e3),!(null!==e&&void 0!==e&&e.out)){d.next=50;break}g=_createForOfIteratorHelper(e.out),d.prev=7,g.s();case 9:if((h=g.n()).done){d.next=42;break}if(j=h.value,k=j.tape.find(function(a){return a.cell[0].s===_config.BAP_BITCOM_ADDRESS&&"DATA"!==a.cell[1].s}),l=j.tape.find(function(a){return a.cell[0].s===_config.BAP_BITCOM_ADDRESS&&"DATA"===a.cell[1].s}),m=j.tape.find(function(a){return a.cell[0].s===_config.AIP_BITCOM_ADDRESS}),l&&!k&&(k=l),!(null!==(i=k)&&void 0!==i&&i.cell&&null!==m&&void 0!==m&&m.cell)){d.next=40;break}if(d.prev=16,console.log("got BAP transaction",f,b||"mempool"),n=parseBAPTransaction(k.cell,m.cell,null===l||void 0===l?void 0:l.cell),!n){d.next=27;break}return n.txId=f,n.block=b,n.timestamp=c,d.next=25,processBapTransaction(n);case 25:d.next=31;break;case 27:return j.txId=f,j.block=b,d.next=31,addBAPErrorTransaction(j);case 31:d.next=40;break;case 33:return d.prev=33,d.t0=d["catch"](16),j.txId=f,j.block=b,j.error=JSON.stringify(d.t0,Object.getOwnPropertyNames(d.t0)),d.next=40,addBAPErrorTransaction(j);case 40:d.next=9;break;case 42:d.next=47;break;case 44:d.prev=44,d.t1=d["catch"](7),g.e(d.t1);case 47:return d.prev=47,g.f(),d.finish(47);case 50:case"end":return d.stop();}},d,null,[[7,44,47,50],[16,33]])}));return function(){return a.apply(this,arguments)}}();exports.processEvent=processEvent;var watchBAPTransactions=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(a){var c,d,e,f,g,h;return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.next=2,getLastBlockIndex();case 2:return c=b.sent,d=new _jsJunglebus.JungleBusClient("junglebus.gorillapool.io",{useSSL:!0,onConnected:function onConnected(){},onConnecting:function onConnecting(){},onDisconnected:function onDisconnected(){},onError:function(a){console.error(a)}}),e=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(a){return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.next=2,processEvent(a.transaction,a.block_height,a.block_time);case 2:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}(),f=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(a){return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(a.statusCode!==_jsJunglebus.ControlMessageStatusCode.BLOCK_DONE){b.next=5;break}return b.next=3,updateLastBlock(a.block);case 3:b.next=6;break;case 5:a.statusCode===_jsJunglebus.ControlMessageStatusCode.ERROR&&console.error(a);case 6:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}(),g=function(a){console.error(a)},h=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(a){return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.next=2,processEvent(a.transaction,0,0);case 2:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}(),b.abrupt("return",d.Subscribe(a||_config.SUBSCRIPTION_ID,c,e,f,g,h));case 9:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}();exports.watchBAPTransactions=watchBAPTransactions;