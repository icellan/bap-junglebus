"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.handleRevokeTransaction=exports.handleDataTransaction=exports.handleAttestationTransaction=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_id=require("./id"),_attest=require("./schemas/attest"),_bap=require("./bap"),handleAttestationTransaction=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(a){var c,d,e,f,g,h,i,j,k;return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if("ATTEST"===a.type){b.next=2;break}return b.abrupt("return");case 2:return b.next=4,(0,_id.getIdForAddress)(a.signatureAddress);case 4:return c=b.sent,b.next=7,(0,_id.wasIdValidForAddressAt)(a.signatureAddress,a.block,c);case 7:if(d=b.sent,!(c&&d)){b.next=36;break}return e=c._id,f={idKey:e,address:a.signatureAddress,txId:a._id,block:a.block,sequence:+a.sequence},a.data&&(f.data=a.data),b.next=14,_attest.Attest.findOne({_id:a.hash});case 14:if(g=b.sent,!g){b.next=32;break}if(i=null===(h=g.signers)||void 0===h?void 0:h.find(function(b){return b.txId===a.txId}),!i){b.next=22;break}return b.next=20,_attest.Attest.update({_id:a.hash,"signers.txId":a._id},{$set:{"signers.$.block":a.block}});case 20:b.next=30;break;case 22:if(k=null===(j=g.signers)||void 0===j?void 0:j.find(function(a){return a.idKey===e}),!k){b.next=28;break}return b.next=26,_attest.Attest.updateOne({_id:a.hash,"signers.idKey":e,"signers.sequence":{$lt:+a.sequence}},{$set:{"signers.$.sequence":+a.sequence},$unset:{"signers.$.revokedId":a._id}});case 26:b.next=30;break;case 28:return b.next=30,_attest.Attest.update({_id:a.hash},{$addToSet:{signers:f}});case 30:b.next=34;break;case 32:return b.next=34,_attest.Attest.insert({_id:a.hash,signers:[f]});case 34:b.next=38;break;case 36:return b.next=38,(0,_bap.addBAPErrorTransaction)({txId:a._id,doc:a,error:"Could not validate attestation",id:c,validAddress:d});case 38:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}();exports.handleAttestationTransaction=handleAttestationTransaction;var handleRevokeTransaction=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(a){var c,d,e,f;return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if("REVOKE"===a.type){b.next=2;break}return b.abrupt("return");case 2:return b.next=4,(0,_id.getIdForAddress)(a.signatureAddress);case 4:return c=b.sent,b.next=7,(0,_id.wasIdValidForAddressAt)(a.signatureAddress,a.block,c);case 7:if(d=b.sent,!(c&&d)){b.next=16;break}return e=c._id,b.next=12,_attest.Attest.findOne({_id:a.hash});case 12:if(f=b.sent,!f){b.next=16;break}return b.next=16,_attest.Attest.updateOne({_id:a.hash,"signers.idKey":e,"signers.sequence":{$lt:+a.sequence}},{$set:{"signers.$.revokedId":a._id,"signers.$.sequence":+a.sequence}});case 16:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}();exports.handleRevokeTransaction=handleRevokeTransaction;var handleDataTransaction=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(a){var c,d,e,f;return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if("DATA"===a.type){b.next=2;break}return b.abrupt("return");case 2:return b.next=4,(0,_id.getIdForAddress)(a.signatureAddress);case 4:return c=b.sent,b.next=7,(0,_id.wasIdValidForAddressAt)(a.signatureAddress,a.block,c);case 7:if(d=b.sent,!(c&&d)){b.next=16;break}return e=c._id,b.next=12,_attest.Attest.findOne({_id:a.hash});case 12:if(f=b.sent,!f){b.next=16;break}return b.next=16,_attest.Attest.updateOne({_id:a.hash,"signers.idKey":e},{$set:{"signers.$.data":a.sequence}});case 16:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}();exports.handleDataTransaction=handleDataTransaction;