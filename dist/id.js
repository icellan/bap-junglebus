"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.wasIdValidForAddressAt=exports.handleIDTransaction=exports.handleAliasTransaction=exports.getIdKeyForAddress=exports.getIdForAddress=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_bsv=_interopRequireDefault(require("bsv")),_id=require("./schemas/id"),getIdForAddress=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(a){return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.abrupt("return",_id.ID.findOne({"addresses.address":a}));case 1:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}();exports.getIdForAddress=getIdForAddress;var getIdKeyForAddress=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(a){var c;return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.next=2,getIdForAddress(a);case 2:return c=b.sent,b.abrupt("return",c?c._id:null);case 4:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}();exports.getIdKeyForAddress=getIdKeyForAddress;var wasIdValidForAddressAt=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function d(b,a,c){var e,f,g,h;return _regenerator["default"].wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(d.t1=c,d.t1){d.next=5;break}return d.next=4,getIdForAddress(b);case 4:d.t1=d.sent;case 5:if(d.t0=d.t1,d.t0){d.next=8;break}d.t0={addresses:[]};case 8:if(c=d.t0,!a){d.next=15;break}return e=c.addresses.find(function(c){return c.address===b}),f=c.addresses.find(function(b){return b.block>e.block}),g=e&&e.block<=a&&(!f||f.block>a),h=!a||a>=c.firstSeen,d.abrupt("return",h&&!!e&&g);case 15:return d.abrupt("return",b===c.currentAddress);case 16:case"end":return d.stop();}},d)}));return function(){return a.apply(this,arguments)}}();exports.wasIdValidForAddressAt=wasIdValidForAddressAt;var handleAliasTransaction=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(a){var c,d,e,f,g;return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if("ALIAS"===a.type){b.next=2;break}return b.abrupt("return");case 2:return c=a.hash,d=a.sequence,e=a._id,b.next=7,_id.ID.findOne({_id:c});case 7:return f=b.sent,b.next=10,wasIdValidForAddressAt(a.signatureAddress,a.block,f);case 10:if(g=b.sent,!(f&&g)){b.next=14;break}return b.next=14,_id.ID.updateOne({_id:c},{$set:{identity:d,identityTxId:e}});case 14:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}();exports.handleAliasTransaction=handleAliasTransaction;var handleIDTransaction=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(a){var c,d,e,f,g,h;return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if("ID"===a.type){b.next=2;break}return b.abrupt("return");case 2:return c=a.hash,b.next=5,_id.ID.findOne({_id:c});case 5:if(d=b.sent,!d){b.next=23;break}if(e=d.addresses.find(function(b){return b.txId===a._id}),!e){b.next=17;break}if(!a.block){b.next=12;break}return b.next=12,_id.ID.updateOne({_id:a.hash,"addresses.txId":a._id},{$set:{"addresses.$.block":a.block}});case 12:if(d.firstSeen||d.addresses[0].txId!==a._id){b.next=15;break}return b.next=15,_id.ID.updateOne({_id:a.hash},{$set:{firstSeen:a.block}});case 15:b.next=21;break;case 17:if(f=d.addresses[d.addresses.length-1],f.address!==a.signatureAddress){b.next=21;break}return b.next=21,_id.ID.updateOne({_id:a.hash},{$set:{currentAddress:a.sequence},$addToSet:{addresses:{address:a.sequence,txId:a._id,block:a.block}}});case 21:b.next=30;break;case 23:if(g=!1,!(g&&(!a.block||675400<a.block))){b.next=28;break}if(h=_bsv["default"].encoding.Base58(_bsv["default"].crypto.Hash.ripemd160(Buffer.from(a.signatureAddress))).toString(),h===a.hash){b.next=28;break}throw new Error("Id key does not match root address");case 28:return b.next=30,_id.ID.insert({_id:a.hash,firstSeen:a.block,rootAddress:a.signatureAddress,currentAddress:a.sequence,addresses:[{address:a.sequence,txId:a._id,block:a.block}]});case 30:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}();exports.handleIDTransaction=handleIDTransaction;