"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.BAP=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_simplSchema=_interopRequireDefault(require("simpl-schema")),_collection=require("../lib/collection"),_attest=require("../attest"),_id=require("../id"),BAP=new _collection.Collection("bap",new _simplSchema["default"]({block:{type:_simplSchema["default"].Integer,label:"Block number this transaction was mined into - null if still in mempool",optional:!0},type:{type:String,label:"Type of BAP transaction (ID, ATTEST, DATA, ALIAS, ...)",optional:!1},hash:{type:String,label:"ID key or attestation hash",optional:!1},sequence:{type:String,label:"Sequences number of the attestation, or the address of the ID",optional:!1},signatureAddress:{type:String,label:"Bitcoin address this bap transaction was signed with",optional:!1},data:{type:String,label:"Optional data that was appended to this BAP transaction",optional:!0},timestamp:{type:_simplSchema["default"].Integer,label:"timestamp the transaction was broadcast - if available",optional:!0},processed:{type:Boolean},error:{type:String}}));exports.BAP=BAP;var processBAPinserts=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function c(a,b){var d;return _regenerator["default"].wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(!(b.$set&&b.$set.type&&b.$set.hash&&b.$set.sequence&&b.$set.signatureAddress)){c.next=34;break}if(c.prev=1,d=b.$set.type,"ATTEST"!==d){c.next=8;break}return c.next=6,(0,_attest.handleAttestationTransaction)(b.$set);case 6:c.next=26;break;case 8:if("ID"!==d){c.next=13;break}return c.next=11,(0,_id.handleIDTransaction)(b.$set);case 11:c.next=26;break;case 13:if("REVOKE"!==d){c.next=18;break}return c.next=16,(0,_attest.handleRevokeTransaction)(b.$set);case 16:c.next=26;break;case 18:if("ALIAS"!==d){c.next=23;break}return c.next=21,(0,_id.handleAliasTransaction)(b.$set);case 21:c.next=26;break;case 23:if("DATA"!==d){c.next=26;break}return c.next=26,(0,_attest.handleDataTransaction)(b.$set);case 26:return c.next=28,BAP.update({_id:a._id},{$set:{processed:!0}});case 28:c.next=34;break;case 30:return c.prev=30,c.t0=c["catch"](1),c.next=34,BAP.update({_id:a._id},{$set:{error:JSON.stringify(c.t0,Object.getOwnPropertyNames(c.t0))}});case 34:case"end":return c.stop();}},c,null,[[1,30]])}));return function(){return a.apply(this,arguments)}}();BAP.after("insert",function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function b(a){return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.next=2,processBAPinserts(a,{$set:a});case 2:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}()),BAP.after("updateOne",function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function c(a,b){return _regenerator["default"].wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,processBAPinserts(a,b);case 2:case"end":return c.stop();}},c)}));return function(){return a.apply(this,arguments)}}());